<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=1024, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, 'Helvetica Neue', sans-serif;
            background: #0b0e13;
            color: #e4e8ee;
            -webkit-font-smoothing: antialiased;
        }

        .dashboard {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            padding: 14px 18px 10px;
            overflow: hidden;
            background: -webkit-linear-gradient(top, #0e1218 0%, #0b0e13 40%, #0d1019 100%);
            background: linear-gradient(180deg, #0e1218 0%, #0b0e13 40%, #0d1019 100%);
        }

        /* ===== HEADER ===== */
        .header {
            height: 50px;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: baseline;
            align-items: baseline;
            padding: 0 2px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .header-clock {
            font-size: 38px;
            font-weight: 100;
            letter-spacing: 3px;
            color: #ffffff;
            margin-right: 16px;
        }

        .header-date {
            font-size: 16px;
            font-weight: 400;
            color: #5a6a7a;
            -webkit-flex: 1 1 auto;
            flex: 1 1 auto;
        }

        .header-live {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            font-size: 12px;
            color: #3a4a5a;
            letter-spacing: 1px;
        }

        .live-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #34c759;
            margin-right: 6px;
            -webkit-animation: livePulse 2s ease-in-out infinite;
            animation: livePulse 2s ease-in-out infinite;
        }

        /* ===== LAYOUT - absolute positioning for Safari 9 ===== */
        .main-row {
            position: absolute;
            top: 64px;
            left: 18px;
            right: 18px;
            height: 330px;
            display: -webkit-flex;
            display: flex;
        }

        .weather-card {
            width: 290px;
            height: 330px;
            margin-right: 14px;
            -webkit-flex: 0 0 290px;
            flex: 0 0 290px;
        }

        .subway-card {
            -webkit-flex: 1 1 0%;
            flex: 1 1 0%;
            height: 330px;
            overflow: hidden;
        }

        .calendar-row {
            position: absolute;
            top: 404px;
            left: 18px;
            right: 18px;
            bottom: 36px;
            overflow: hidden;
        }

        .footer {
            position: absolute;
            bottom: 8px;
            left: 0;
            right: 0;
            height: 22px;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
        }

        .footer-text {
            font-size: 12px;
            color: #2d3a4a;
            letter-spacing: 0.5px;
        }

        /* ===== CARD ===== */
        .card {
            background: -webkit-linear-gradient(top, #161d28, #131a24);
            background: linear-gradient(180deg, #161d28, #131a24);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            -webkit-box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 1px 0 rgba(255, 255, 255, 0.03) inset;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 1px 0 rgba(255, 255, 255, 0.03) inset;
            padding: 16px 20px;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .card-header {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 14px;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
        }

        .card-label {
            font-size: 13px;
            font-weight: 600;
            color: #4a5a6a;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .card-badge {
            margin-left: auto;
            font-size: 12px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 10px;
            letter-spacing: 0.5px;
        }

        .card-body {
            overflow: hidden;
        }

        /* ===== WEATHER ===== */
        .weather-main {
            text-align: center;
            padding: 4px 0 0;
        }

        .weather-icon-large {
            font-size: 48px;
            line-height: 1;
            margin-bottom: 2px;
        }

        .weather-temp {
            font-size: 54px;
            font-weight: 100;
            letter-spacing: -3px;
            line-height: 1.1;
            color: #ffffff;
        }

        .weather-temp .unit {
            font-size: 22px;
            font-weight: 200;
            color: #4a5a6a;
            vertical-align: top;
        }

        .weather-desc {
            font-size: 15px;
            color: #5a6a7a;
            margin-top: 2px;
            font-weight: 500;
        }

        .weather-hilo {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: center;
            justify-content: center;
            margin-top: 10px;
            font-size: 14px;
            color: #4a5a6a;
        }

        .weather-hilo-item {
            margin: 0 10px;
        }

        .weather-hilo-item .v {
            font-weight: 600;
        }

        .weather-hilo-item.hi .v { color: #e86b6b; }
        .weather-hilo-item.lo .v { color: #6bb3e8; }

        .weather-meta {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.04);
        }

        .weather-meta-row {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            font-size: 14px;
            padding: 4px 0;
        }

        .weather-meta-label {
            color: #3d4d5d;
        }

        .weather-meta-val {
            color: #7a8a9a;
            font-weight: 600;
        }

        /* ===== SUBWAY ===== */
        .subway-line-bar {
            height: 3px;
            border-radius: 2px;
            background: -webkit-linear-gradient(left, #d4a43a, #c4963a 50%, rgba(196,150,58,0.2));
            background: linear-gradient(90deg, #d4a43a, #c4963a 50%, rgba(196,150,58,0.2));
            margin-bottom: 14px;
        }

        .subway-list {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
        }

        .arrival-item {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 16px 18px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            -webkit-animation: fadeIn 0.4s ease-out;
            animation: fadeIn 0.4s ease-out;
        }

        .arrival-type-bar {
            width: 3px;
            height: 36px;
            border-radius: 2px;
            background: #d4a43a;
            margin-right: 14px;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
        }

        .arrival-normal .arrival-type-bar {
            background: #3d4d5d;
        }

        .arrival-info {
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
        }

        .arrival-dest {
            font-size: 16px;
            font-weight: 500;
            color: #c8d0d8;
            margin-bottom: 4px;
        }

        .badge-express {
            display: inline-block;
            background: rgba(212, 164, 58, 0.15);
            color: #d4a43a;
            font-size: 12px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }

        .badge-normal {
            display: inline-block;
            background: rgba(90, 106, 122, 0.15);
            color: #5a6a7a;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .arrival-normal {
            opacity: 0.65;
        }

        .arrival-detail {
            font-size: 13px;
            color: #3d4d5d;
        }

        .arrival-time {
            text-align: right;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .arrival-time-msg {
            font-size: 20px;
            font-weight: 600;
            color: #7aaddf;
        }

        .arrival-time-msg.arriving {
            color: #4ade80;
            -webkit-animation: pulse 1.5s ease-in-out infinite;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* ===== CALENDAR ===== */
        .calendar-list {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: 100%;
        }

        .calendar-event {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.02);
            -webkit-animation: fadeIn 0.4s ease-out;
            animation: fadeIn 0.4s ease-out;
        }

        .cal-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4a8ed4;
            margin-right: 14px;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
        }

        .cal-dot.allday {
            background: #d4a43a;
        }

        .calendar-time-col {
            width: 110px;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
            margin-right: 14px;
        }

        .calendar-time {
            font-size: 16px;
            font-weight: 600;
            color: #7a8a9a;
            line-height: 1.3;
        }

        .calendar-time-end {
            font-size: 13px;
            color: #3d4d5d;
        }

        .calendar-event-allday {
            font-size: 13px;
            color: #d4a43a;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .calendar-event-title {
            font-size: 16px;
            font-weight: 500;
            color: #c8d0d8;
            line-height: 1.3;
            -webkit-flex: 1;
            flex: 1;
        }

        /* ===== STATES ===== */
        .loading {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            height: 100%;
            color: #3d4d5d;
            font-size: 12px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(74, 142, 212, 0.1);
            border-top-color: #4a8ed4;
            border-radius: 50%;
            margin-bottom: 10px;
            -webkit-animation: spin 0.8s linear infinite;
            animation: spin 0.8s linear infinite;
        }

        .empty-state {
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            height: 100%;
            color: #3d4d5d;
            font-size: 13px;
            text-align: center;
            line-height: 1.8;
        }

        .error-state {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            height: 100%;
            color: #4a5a6a;
            font-size: 12px;
            text-align: center;
        }

        .error-icon { font-size: 22px; margin-bottom: 8px; opacity: 0.5; }
        .error-msg { margin-bottom: 10px; line-height: 1.5; }

        .retry-btn {
            background: rgba(74, 142, 212, 0.1);
            color: #4a8ed4;
            border: 1px solid rgba(74, 142, 212, 0.15);
            padding: 5px 14px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .retry-btn:active { background: rgba(74, 142, 212, 0.2); }

        .config-hint {
            color: #3d4d5d;
            font-size: 11px;
            margin-top: 8px;
            line-height: 1.6;
        }

        .config-hint code {
            background: rgba(255, 255, 255, 0.04);
            padding: 1px 5px;
            border-radius: 3px;
            font-family: 'Menlo', monospace;
            font-size: 10px;
        }

        /* ===== ANIMATIONS ===== */
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @-webkit-keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        @-webkit-keyframes fadeIn {
            from { opacity: 0; -webkit-transform: translateY(4px); }
            to { opacity: 1; -webkit-transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @-webkit-keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-clock" id="header-clock">--:--:--</div>
            <div class="header-date" id="header-date"></div>
            <div class="header-live">
                <span class="live-dot"></span>
                LIVE
            </div>
        </div>

        <!-- Top Row -->
        <div class="main-row">
            <!-- Weather -->
            <div class="weather-card">
                <div class="card">
                    <div class="card-header">
                        <span class="card-label">Seoul Weather</span>
                    </div>
                    <div class="card-body" id="weather-content">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Subway -->
            <div class="subway-card">
                <div class="card">
                    <div class="card-header">
                        <span class="card-label">ì¢…í•©ìš´ë™ì¥</span>
                        <span class="card-badge" style="background:rgba(212,164,58,0.12);color:#d4a43a;">9í˜¸ì„  &middot; ê¹€í¬ê³µí•­</span>
                    </div>
                    <div class="subway-line-bar"></div>
                    <div class="card-body" id="subway-content">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-row">
            <div class="card">
                <div class="card-header">
                    <span class="card-label">ì˜¤ëŠ˜ì˜ ì¼ì •</span>
                    <span class="card-badge" id="calendar-date" style="background:rgba(74,142,212,0.1);color:#4a8ed4;"></span>
                </div>
                <div class="card-body" id="calendar-content">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <span class="footer-text">UPDATED <span id="last-update">--:--</span></span>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // ===== CONFIGURATION =====
        var CONFIG = {
            SUBWAY_API_KEY: '636b46446c6b6576383963595a7976',
            CALENDAR_ICAL_URL: 'https://calendar.google.com/calendar/ical/49a7qv0ovbndru2gdiirhditq8%40group.calendar.google.com/private-595c535a853512550a101afab2eb1756/basic.ics',
            CLOCK_REFRESH: 1000,
            SUBWAY_REFRESH: 30000,
            WEATHER_REFRESH: 600000,
            CALENDAR_REFRESH: 300000,
            SUBWAY_API_BASE: 'http://swopenAPI.seoul.go.kr/api/subway/'
        };

        // ===== UTILITIES =====
        function $(id) { return document.getElementById(id); }
        function padZero(n) { return n < 10 ? '0' + n : '' + n; }

        function formatTime(d) {
            return padZero(d.getHours()) + ':' + padZero(d.getMinutes()) + ':' + padZero(d.getSeconds());
        }

        function formatTimeShort(d) {
            return padZero(d.getHours()) + ':' + padZero(d.getMinutes());
        }

        function formatDate(d) {
            var days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return d.getFullYear() + 'ë…„ ' + (d.getMonth() + 1) + 'ì›” ' + d.getDate() + 'ì¼ ' + days[d.getDay()] + 'ìš”ì¼';
        }

        var PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?'
        ];

        function xhr(url, callback) {
            var req = new XMLHttpRequest();
            req.open('GET', url, true);
            req.onreadystatechange = function() {
                if (req.readyState === 4) {
                    if (req.status === 200) {
                        try { callback(null, JSON.parse(req.responseText)); }
                        catch (e) { callback(e, null); }
                    } else {
                        callback(new Error('HTTP ' + req.status), null);
                    }
                }
            };
            req.onerror = function() { callback(new Error('Network error'), null); };
            req.send();
        }

        function xhrProxy(apiUrl, callback, idx) {
            if (idx === undefined) idx = 0;
            if (idx >= PROXIES.length) { callback(new Error('All proxies failed'), null); return; }
            var url = PROXIES[idx] + encodeURIComponent(apiUrl);
            xhr(url, function(err, data) {
                if (err) { xhrProxy(apiUrl, callback, idx + 1); }
                else { callback(null, data); }
            });
        }

        function xhrProxyRaw(apiUrl, callback, idx) {
            if (idx === undefined) idx = 0;
            if (idx >= PROXIES.length) { callback(new Error('All proxies failed'), null); return; }
            var url = PROXIES[idx] + encodeURIComponent(apiUrl);
            var req = new XMLHttpRequest();
            req.open('GET', url, true);
            req.onreadystatechange = function() {
                if (req.readyState === 4) {
                    if (req.status === 200) { callback(null, req.responseText); }
                    else { xhrProxyRaw(apiUrl, callback, idx + 1); }
                }
            };
            req.onerror = function() { xhrProxyRaw(apiUrl, callback, idx + 1); };
            req.send();
        }

        function updateLastRefresh() {
            $('last-update').innerHTML = formatTimeShort(new Date());
        }

        // ===== WEATHER =====
        var weatherCodes = {
            0: ['ë§‘ìŒ', 'â˜€'], 1: ['ëŒ€ì²´ë¡œ ë§‘ìŒ', 'ğŸŒ¤'], 2: ['êµ¬ë¦„ ì¡°ê¸ˆ', 'â›…'], 3: ['íë¦¼', 'â˜'],
            45: ['ì•ˆê°œ', 'ğŸŒ«'], 48: ['ì•ˆê°œ', 'ğŸŒ«'],
            51: ['ê°€ë²¼ìš´ ì´ìŠ¬ë¹„', 'ğŸŒ¦'], 53: ['ì´ìŠ¬ë¹„', 'ğŸŒ§'], 55: ['ê°•í•œ ì´ìŠ¬ë¹„', 'ğŸŒ§'],
            56: ['ì‚´ì–¼ìŒ ì´ìŠ¬ë¹„', 'ğŸŒ§'], 57: ['ì‚´ì–¼ìŒ ì´ìŠ¬ë¹„', 'ğŸŒ§'],
            61: ['ì•½í•œ ë¹„', 'ğŸŒ§'], 63: ['ë¹„', 'ğŸŒ§'], 65: ['ê°•í•œ ë¹„', 'ğŸŒ§'],
            66: ['ì‚´ì–¼ìŒ ë¹„', 'ğŸŒ§'], 67: ['ê°•í•œ ì‚´ì–¼ìŒ ë¹„', 'ğŸŒ§'],
            71: ['ì•½í•œ ëˆˆ', 'ğŸŒ¨'], 73: ['ëˆˆ', 'â„'], 75: ['ê°•í•œ ëˆˆ', 'â„'], 77: ['ì‹¸ë½ëˆˆ', 'â„'],
            80: ['ì†Œë‚˜ê¸°', 'ğŸŒ¦'], 81: ['ì†Œë‚˜ê¸°', 'ğŸŒ§'], 82: ['ê°•í•œ ì†Œë‚˜ê¸°', 'ğŸŒ§'],
            85: ['ì•½í•œ ëˆˆë³´ë¼', 'ğŸŒ¨'], 86: ['ëˆˆë³´ë¼', 'â„'],
            95: ['ë‡Œìš°', 'â›ˆ'], 96: ['ìš°ë°• ë‡Œìš°', 'â›ˆ'], 99: ['ìš°ë°• ë‡Œìš°', 'â›ˆ']
        };

        function getWeatherInfo(code) { return weatherCodes[code] || ['ì•Œ ìˆ˜ ì—†ìŒ', '?']; }

        var airData = null;

        function fetchWeather() {
            var apiUrl = 'https://api.open-meteo.com/v1/forecast' +
                '?latitude=37.5665&longitude=126.9780' +
                '&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code' +
                '&daily=temperature_2m_max,temperature_2m_min,weather_code' +
                '&timezone=Asia%2FSeoul&forecast_days=1';

            xhrProxy(apiUrl, function(err, data) {
                if (err) { renderWeatherError(); return; }
                fetchAirQuality(data);
            });
        }

        function fetchAirQuality(weatherData) {
            var aqUrl = 'https://air-quality-api.open-meteo.com/v1/air-quality' +
                '?latitude=37.5665&longitude=126.9780&current=pm2_5,pm10';

            xhrProxy(aqUrl, function(err, data) {
                if (!err && data && data.current) {
                    airData = data.current;
                }
                renderWeather(weatherData);
                updateLastRefresh();
            });
        }

        function pmLevel(type, val) {
            if (type === 'pm25') {
                if (val <= 15) return ['ì¢‹ìŒ', '#4ade80'];
                if (val <= 35) return ['ë³´í†µ', '#7aaddf'];
                if (val <= 75) return ['ë‚˜ì¨', '#f59e0b'];
                return ['ë§¤ìš°ë‚˜ì¨', '#ef4444'];
            }
            if (val <= 30) return ['ì¢‹ìŒ', '#4ade80'];
            if (val <= 80) return ['ë³´í†µ', '#7aaddf'];
            if (val <= 150) return ['ë‚˜ì¨', '#f59e0b'];
            return ['ë§¤ìš°ë‚˜ì¨', '#ef4444'];
        }

        function renderWeather(data) {
            var c = data.current;
            var d = data.daily;
            var temp = Math.round(c.temperature_2m);
            var feels = Math.round(c.apparent_temperature);
            var humidity = Math.round(c.relative_humidity_2m);
            var info = getWeatherInfo(c.weather_code);
            var hi = Math.round(d.temperature_2m_max[0]);
            var lo = Math.round(d.temperature_2m_min[0]);

            var dustHtml = '';
            if (airData) {
                var pm25 = Math.round(airData.pm2_5);
                var pm10 = Math.round(airData.pm10);
                var lv25 = pmLevel('pm25', pm25);
                var lv10 = pmLevel('pm10', pm10);
                dustHtml =
                    '<div class="weather-meta-row"><span class="weather-meta-label">ë¯¸ì„¸ë¨¼ì§€</span>' +
                        '<span class="weather-meta-val">' + pm10 + ' <span style="color:' + lv10[1] + '">' + lv10[0] + '</span></span></div>' +
                    '<div class="weather-meta-row"><span class="weather-meta-label">ì´ˆë¯¸ì„¸ë¨¼ì§€</span>' +
                        '<span class="weather-meta-val">' + pm25 + ' <span style="color:' + lv25[1] + '">' + lv25[0] + '</span></span></div>';
            }

            $('weather-content').innerHTML =
                '<div class="weather-main">' +
                    '<div class="weather-icon-large">' + info[1] + '</div>' +
                    '<div class="weather-temp">' + temp + '<span class="unit">&deg;</span></div>' +
                    '<div class="weather-desc">' + info[0] + '</div>' +
                    '<div class="weather-hilo">' +
                        '<span class="weather-hilo-item hi"><span class="v">' + hi + '&deg;</span> ìµœê³ </span>' +
                        '<span class="weather-hilo-item lo"><span class="v">' + lo + '&deg;</span> ìµœì €</span>' +
                    '</div>' +
                '</div>' +
                '<div class="weather-meta">' +
                    '<div class="weather-meta-row"><span class="weather-meta-label">ì²´ê° ' + feels + '&deg;</span><span class="weather-meta-val">ìŠµë„ ' + humidity + '%</span></div>' +
                    dustHtml +
                '</div>';
        }

        function renderWeatherError() {
            $('weather-content').innerHTML =
                '<div class="error-state"><div class="error-icon">&#9888;</div><div class="error-msg">ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>' +
                '<button class="retry-btn" onclick="window._retryWeather()">ë‹¤ì‹œ ì‹œë„</button></div>';
        }
        window._retryWeather = fetchWeather;

        // ===== SUBWAY =====
        function fetchSubway() {
            if (!CONFIG.SUBWAY_API_KEY) { renderSubwayNoKey(); return; }
            var apiUrl = CONFIG.SUBWAY_API_BASE + CONFIG.SUBWAY_API_KEY +
                '/json/realtimeStationArrival/0/20/' + encodeURIComponent('ì¢…í•©ìš´ë™ì¥');

            xhrProxy(apiUrl, function(err, data) {
                if (err) { renderSubwayError(); return; }
                if (data.realtimeArrivalList) {
                    renderSubway(filterLine9Gimpo(data.realtimeArrivalList));
                } else if (data.errorMessage && data.errorMessage.code === 'INFO-200') {
                    renderSubwayEmpty();
                } else { renderSubwayError(); }
                updateLastRefresh();
            });
        }

        function filterLine9Gimpo(list) {
            var results = [];
            for (var i = 0; i < list.length; i++) {
                var t = list[i];
                if (t.subwayId === '1009' &&
                    (t.bstatnNm === 'ê¹€í¬ê³µí•­' || t.bstatnNm === 'ê°œí™”')) {
                    results.push(t);
                }
            }
            results.sort(function(a, b) { return (a.ordkey || '').localeCompare(b.ordkey || ''); });
            return results;
        }

        function isArrivingSoon(msg) {
            if (!msg) return false;
            return msg.indexOf('ë„ì°©') !== -1 || msg.indexOf('ì§„ì…') !== -1 ||
                   msg.indexOf('ì¶œë°œ') !== -1 || msg.indexOf('ì „ì—­') !== -1;
        }

        function renderSubway(trains) {
            if (trains.length === 0) { renderSubwayEmpty(); return; }
            var html = '<div class="subway-list">';
            for (var i = 0; i < trains.length; i++) {
                var t = trains[i];
                var msg = t.arvlMsg2 || '';
                var detail = t.arvlMsg3 || '';
                var dest = t.bstatnNm || 'ê¹€í¬ê³µí•­';
                var isExpress = t.btrainSttus === 'ê¸‰í–‰';
                var badge = isExpress ? '<span class="badge-express">ê¸‰í–‰</span>' : '<span class="badge-normal">ì¼ë°˜</span>';
                var cls = 'arrival-item' + (isExpress ? '' : ' arrival-normal');

                html += '<div class="' + cls + '">' +
                    '<div class="arrival-type-bar"></div>' +
                    '<div class="arrival-info">' +
                        '<div class="arrival-dest">' + dest + 'í–‰ ' + badge + '</div>' +
                        '<div class="arrival-detail">' + detail + '</div>' +
                    '</div>' +
                    '<div class="arrival-time">' +
                        '<div class="arrival-time-msg' + (isArrivingSoon(msg) ? ' arriving' : '') + '">' + msg + '</div>' +
                    '</div>' +
                '</div>';
            }
            html += '</div>';
            $('subway-content').innerHTML = html;
        }

        function renderSubwayEmpty() {
            $('subway-content').innerHTML = '<div class="empty-state">í˜„ì¬ ìš´í–‰ ì¤‘ì¸<br>ì—´ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        function renderSubwayError() {
            $('subway-content').innerHTML =
                '<div class="error-state"><div class="error-icon">&#9888;</div><div class="error-msg">ë„ì°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>' +
                '<button class="retry-btn" onclick="window._retrySubway()">ë‹¤ì‹œ ì‹œë„</button></div>';
        }
        function renderSubwayNoKey() {
            $('subway-content').innerHTML =
                '<div class="error-state"><div class="error-icon">&#128273;</div><div class="error-msg">API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>' +
                '<div class="config-hint"><code>CONFIG.SUBWAY_API_KEY</code><br>data.seoul.go.kr</div></div>';
        }
        window._retrySubway = fetchSubway;

        // ===== CALENDAR (iCal) =====
        function fetchCalendar() {
            if (!CONFIG.CALENDAR_ICAL_URL) { renderCalendarNoUrl(); return; }

            xhrProxyRaw(CONFIG.CALENDAR_ICAL_URL, function(err, text) {
                if (err) { renderCalendarError(); return; }
                renderCalendar(filterToday(parseICal(text)));
                updateLastRefresh();
            });
        }

        function parseICal(text) {
            var events = [];
            var blocks = text.split('BEGIN:VEVENT');
            for (var i = 1; i < blocks.length; i++) {
                var block = blocks[i].split('END:VEVENT')[0];
                var ev = {};
                ev.title = getICalProp(block, 'SUMMARY') || '(ì œëª© ì—†ìŒ)';
                var dtstart = getICalLine(block, 'DTSTART');
                var dtend = getICalLine(block, 'DTEND');
                if (dtstart && dtstart.indexOf('VALUE=DATE') !== -1) {
                    ev.allDay = true;
                    ev.start = parseICalDate(dtstart.split(':').pop());
                    ev.end = dtend ? parseICalDate(dtend.split(':').pop()) : ev.start;
                } else {
                    ev.allDay = false;
                    ev.start = parseICalDateTime(getICalProp(block, 'DTSTART'));
                    ev.end = parseICalDateTime(getICalProp(block, 'DTEND'));
                }
                if (ev.start) events.push(ev);
            }
            return events;
        }

        function getICalProp(block, name) {
            var lines = block.split('\n');
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].replace(/\r/g, '');
                if (line.indexOf(name + ':') === 0) return line.substring(name.length + 1);
                if (line.indexOf(name + ';') === 0) {
                    var ci = line.indexOf(':');
                    if (ci !== -1) return line.substring(ci + 1);
                }
            }
            return '';
        }

        function getICalLine(block, name) {
            var lines = block.split('\n');
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].replace(/\r/g, '');
                if (line.indexOf(name) === 0) return line;
            }
            return '';
        }

        function parseICalDate(str) {
            if (!str || str.length < 8) return null;
            return new Date(parseInt(str.substring(0,4),10), parseInt(str.substring(4,6),10)-1, parseInt(str.substring(6,8),10));
        }

        function parseICalDateTime(str) {
            if (!str || str.length < 15) return null;
            var y=parseInt(str.substring(0,4),10), m=parseInt(str.substring(4,6),10)-1, d=parseInt(str.substring(6,8),10);
            var h=parseInt(str.substring(9,11),10), mi=parseInt(str.substring(11,13),10), s=parseInt(str.substring(13,15),10);
            if (str.charAt(15) === 'Z') return new Date(Date.UTC(y,m,d,h,mi,s));
            return new Date(y,m,d,h,mi,s);
        }

        function filterToday(events) {
            var now = new Date();
            var s = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var e = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
            var r = [];
            for (var i = 0; i < events.length; i++) {
                if (events[i].start < e && (events[i].end || events[i].start) > s) r.push(events[i]);
            }
            r.sort(function(a,b) {
                if (a.allDay && !b.allDay) return -1;
                if (!a.allDay && b.allDay) return 1;
                return a.start - b.start;
            });
            return r;
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function renderCalendar(events) {
            if (events.length === 0) {
                $('calendar-content').innerHTML = '<div class="empty-state">ì˜¤ëŠ˜ì€ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            var html = '<div class="calendar-list">';
            for (var i = 0; i < events.length; i++) {
                var ev = events[i];
                html += '<div class="calendar-event">';
                html += '<div class="cal-dot' + (ev.allDay ? ' allday' : '') + '"></div>';
                html += '<div class="calendar-time-col">';
                if (ev.allDay) {
                    html += '<span class="calendar-event-allday">ALL DAY</span>';
                } else {
                    html += '<span class="calendar-time">' + padZero(ev.start.getHours()) + ':' + padZero(ev.start.getMinutes()) + '</span>';
                    html += ' <span class="calendar-time-end">~ ' + padZero(ev.end.getHours()) + ':' + padZero(ev.end.getMinutes()) + '</span>';
                }
                html += '</div>';
                html += '<div class="calendar-event-title">' + escapeHtml(ev.title) + '</div>';
                html += '</div>';
            }
            html += '</div>';
            $('calendar-content').innerHTML = html;
        }

        function renderCalendarError() {
            $('calendar-content').innerHTML =
                '<div class="error-state"><div class="error-icon">&#9888;</div><div class="error-msg">ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>' +
                '<button class="retry-btn" onclick="window._retryCalendar()">ë‹¤ì‹œ ì‹œë„</button></div>';
        }
        function renderCalendarNoUrl() {
            $('calendar-content').innerHTML =
                '<div class="error-state"><div class="error-icon">&#128273;</div><div class="error-msg">iCal ì£¼ì†Œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>' +
                '<div class="config-hint">Google Calendar ì„¤ì • &gt; ìº˜ë¦°ë” í†µí•©<br><code>CONFIG.CALENDAR_ICAL_URL</code></div></div>';
        }
        window._retryCalendar = fetchCalendar;

        // ===== CLOCK =====
        function updateClock() {
            var now = new Date();
            $('header-clock').innerHTML = formatTime(now);
            $('header-date').innerHTML = formatDate(now);
        }

        function updateCalendarDate() {
            var now = new Date();
            $('calendar-date').innerHTML = (now.getMonth()+1) + 'ì›” ' + now.getDate() + 'ì¼';
        }

        // ===== INIT =====
        function init() {
            updateClock();
            updateCalendarDate();
            fetchWeather();
            fetchSubway();
            fetchCalendar();
            setInterval(updateClock, CONFIG.CLOCK_REFRESH);
            setInterval(fetchWeather, CONFIG.WEATHER_REFRESH);
            setInterval(fetchSubway, CONFIG.SUBWAY_REFRESH);
            setInterval(fetchCalendar, CONFIG.CALENDAR_REFRESH);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else { init(); }
    })();
    </script>
</body>
</html>
